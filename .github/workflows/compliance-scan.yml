name: AI Compliance Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  compliance-scan:
    name: ðŸ›¡ï¸ Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: files
        uses: tj-actions/changed-files@v44
        with:
          files: '**/*.{java,py,js,ts,tf,yaml,yml,json}'

      - name: Cleanup Old Comments
        uses: actions/github-script@v7
        with:
          script: |
            // Delete ALL comments from github-actions bot on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            for (const c of comments) {
              if (c.user?.login === 'github-actions[bot]') {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: c.id
                }).catch(() => {});
              }
            }
            // Delete ALL review comments from bot
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            for (const rc of reviewComments) {
              if (rc.user?.login === 'github-actions[bot]') {
                await github.rest.pulls.deleteReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: rc.id
                }).catch(() => {});
              }
            }
            console.log('Cleanup done');

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install google-generativeai

      - name: Run Scan
        id: scan
        env:
          CHANGED_FILES: ${{ steps.files.outputs.all_changed_files }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python .github/scripts/compliance_scanner.py

      - name: Post Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('scan_report.json')) return;
            
            const report = JSON.parse(fs.readFileSync('scan_report.json', 'utf8'));
            const findings = [...(report.blocking_issues || []), ...(report.suggestions || [])];
            const s = report.summary || {};
            const ai = report.ai_insights || {};
            
            // Build summary
            let summary = report.decision === 'BLOCK' ? '## ðŸš« Compliance Check Failed\n\n' : '## âœ… Compliance Check Passed\n\n';
            summary += `| Severity | Count |\n|----------|-------|\n`;
            summary += `| ðŸ”´ Critical | ${s.critical || 0} |\n`;
            summary += `| ðŸŸ  High | ${s.high || 0} |\n`;
            summary += `| ðŸŸ¡ Medium | ${s.medium || 0} |\n`;
            summary += `| ðŸ”µ Low | ${s.low || 0} |\n\n`;
            summary += `**Risk Score:** ${ai.risk_score || 0}/10 | **Files:** ${ai.files_scanned || 0}\n\n`;
            if (ai.executive_summary) summary += `> ${ai.executive_summary}\n\n`;
            
            // Add findings details
            if (findings.length > 0) {
              summary += `### Findings\n\n`;
              for (const f of findings.slice(0, 15)) {
                const sev = (f.severity || 'low').toUpperCase();
                const icon = sev === 'CRITICAL' ? 'ðŸ”´' : sev === 'HIGH' ? 'ðŸŸ ' : 'ðŸŸ¡';
                summary += `${icon} **${f.title}** - \`${f.file}:${f.line}\`\n`;
                if (f.cve_id) summary += `  - CVE: ${f.cve_id}\n`;
                summary += `  - Fix: ${(f.remediation || '').substring(0, 100)}\n\n`;
              }
            }
            
            summary += `---\n*ðŸ¤– AI Compliance Bot | Google Gemini*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Fail if Blocked
        if: steps.scan.outputs.decision == 'BLOCK'
        run: exit 1
