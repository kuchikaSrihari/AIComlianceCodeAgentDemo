# =============================================================================
# AI COMPLIANCE-AS-CODE BOT
# =============================================================================
# Shift-left compliance scanner that runs on every PR
#
# Features:
# - AI-powered code analysis (Google Gemini - FREE)
# - Inline comments on specific code lines
# - SCF, SOC2, HIPAA, PCI-DSS compliance mapping
# - Blocks PRs with critical/high severity issues
#
# Setup:
# 1. Add GEMINI_API_KEY to repository secrets
#    Get free key: https://aistudio.google.com/app/apikey
# 2. Copy this file to .github/workflows/
# 3. Copy compliance_scanner.py to .github/scripts/
# =============================================================================

name: AI Compliance Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

permissions:
  contents: read
  pull-requests: write

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  compliance-scan:
    name: üõ°Ô∏è Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.java
            **/*.py
            **/*.js
            **/*.ts
            **/*.jsx
            **/*.tsx
            **/*.tf
            **/*.yaml
            **/*.yml
            **/*.json
            **/*.xml
            **/*.properties

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install google-generativeai

      - name: Run AI Compliance Scan
        id: scan
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python .github/scripts/compliance_scanner.py

      # Add inline comments on specific code lines
      - name: Add Inline Review Comments
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('scan_report.json')) {
              console.log('No scan report found');
              return;
            }
            
            const report = JSON.parse(fs.readFileSync('scan_report.json', 'utf8'));
            const allFindings = [...(report.blocking_issues || []), ...(report.suggestions || [])];
            
            if (allFindings.length === 0) {
              console.log('No findings to comment on');
              return;
            }
            
            // Get PR info
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const commitId = pr.head.sha;
            const comments = [];
            
            for (const finding of allFindings) {
              if (!finding.file || !finding.line) continue;
              
              const sev = (finding.severity || 'info').toUpperCase();
              const emoji = sev === 'CRITICAL' ? 'üî¥' : sev === 'HIGH' ? 'üü†' : sev === 'MEDIUM' ? 'üü°' : 'üîµ';
              
              let body = `## ${emoji} ${sev}: ${finding.title}\n\n`;
              body += `**üìã Issue:** ${finding.description || 'Security/compliance issue detected'}\n\n`;
              body += `**‚úÖ Fix:** ${finding.remediation || 'Review and fix this issue'}\n\n`;
              
              if (finding.scf_control || finding.soc2_control) {
                body += `**üìä Compliance:**`;
                if (finding.scf_control) body += ` SCF ${finding.scf_control}`;
                if (finding.soc2_control) body += ` | SOC2 ${finding.soc2_control}`;
                body += `\n\n`;
              }
              
              if (finding.compliance_frameworks && finding.compliance_frameworks.length > 0) {
                body += `**üèõÔ∏è Frameworks:** ${finding.compliance_frameworks.join(', ')}\n\n`;
              }
              
              body += `---\n*ü§ñ AI Compliance Bot*`;
              
              comments.push({
                path: finding.file,
                line: parseInt(finding.line) || 1,
                body: body
              });
            }
            
            if (comments.length > 0) {
              try {
                await github.rest.pulls.createReview({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.issue.number,
                  commit_id: commitId,
                  event: report.decision === 'BLOCK' ? 'REQUEST_CHANGES' : 'COMMENT',
                  body: `## üõ°Ô∏è AI Compliance Scan Complete\n\n**Decision:** ${report.decision}\n**Risk Score:** ${report.ai_insights?.risk_score || 0}/10\n**Files Scanned:** ${report.ai_insights?.files_scanned || 0}\n\n${report.decision === 'BLOCK' ? '‚ö†Ô∏è Please fix the issues marked in the code review.' : '‚úÖ No blocking issues found.'}`,
                  comments: comments.slice(0, 50)  // GitHub limits to 50 comments per review
                });
                console.log(`Created review with ${comments.length} inline comments`);
              } catch (e) {
                console.log('Review creation failed:', e.message);
              }
            }

      # Summary comment on PR
      - name: Post Summary Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('scan_report.json')) return;
            
            const report = JSON.parse(fs.readFileSync('scan_report.json', 'utf8'));
            const s = report.summary || {};
            const ai = report.ai_insights || {};
            
            let comment = report.decision === 'BLOCK' 
              ? `## üö´ Compliance Check Failed\n\n`
              : `## ‚úÖ Compliance Check Passed\n\n`;
            
            comment += `| Severity | Count |\n|----------|-------|\n`;
            comment += `| üî¥ Critical | ${s.critical || 0} |\n`;
            comment += `| üü† High | ${s.high || 0} |\n`;
            comment += `| üü° Medium | ${s.medium || 0} |\n`;
            comment += `| üîµ Low | ${s.low || 0} |\n\n`;
            
            comment += `### ü§ñ AI Analysis\n`;
            comment += `- **Risk Score:** ${ai.risk_score || 0}/10\n`;
            comment += `- **Files Scanned:** ${ai.files_scanned || 0}\n`;
            if (ai.executive_summary) {
              comment += `- **Summary:** ${ai.executive_summary}\n`;
            }
            
            if (report.decision === 'BLOCK') {
              comment += `\n‚ö†Ô∏è **See inline comments on code for specific issues and fixes.**\n`;
            }
            
            comment += `\n---\n*ü§ñ AI Compliance-as-Code Bot | Powered by Google Gemini*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if Blocked
        if: steps.scan.outputs.decision == 'BLOCK'
        run: |
          echo "::error::PR blocked due to compliance violations"
          exit 1
