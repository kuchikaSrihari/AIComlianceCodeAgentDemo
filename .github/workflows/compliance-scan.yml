name: AI Compliance Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  compliance-scan:
    name: üõ°Ô∏è Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: files
        uses: tj-actions/changed-files@v44
        with:
          files: '**/*.{java,py,js,ts,tf,yaml,yml,json}'

      - name: Cleanup Old Comments
        uses: actions/github-script@v7
        with:
          script: |
            // Delete ALL comments from github-actions bot on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            for (const c of comments) {
              if (c.user?.login === 'github-actions[bot]') {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: c.id
                }).catch(() => {});
              }
            }
            // Delete ALL review comments from bot
            const { data: reviewComments } = await github.rest.pulls.listReviewComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            for (const rc of reviewComments) {
              if (rc.user?.login === 'github-actions[bot]') {
                await github.rest.pulls.deleteReviewComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: rc.id
                }).catch(() => {});
              }
            }
            console.log('Cleanup done');

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install google-generativeai

      - name: Run Scan
        id: scan
        env:
          CHANGED_FILES: ${{ steps.files.outputs.all_changed_files }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: python .github/scripts/compliance_scanner.py

      - name: Post Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('scan_report.json')) return;
            
            const report = JSON.parse(fs.readFileSync('scan_report.json', 'utf8'));
            const findings = [...(report.blocking_issues || []), ...(report.suggestions || [])];
            const s = report.summary || {};
            const ai = report.ai_insights || {};
            
            // Build summary
            let summary = report.decision === 'BLOCK' ? '## üö´ Compliance Check Failed\n\n' : '## ‚úÖ Compliance Check Passed\n\n';
            
            // Severity table
            summary += `### üìä Scan Summary\n\n`;
            summary += `| Severity | Count | | Metric | Value |\n`;
            summary += `|----------|-------|-|--------|-------|\n`;
            summary += `| üî¥ Critical | ${s.critical || 0} | | Risk Score | ${ai.risk_score || 0}/10 |\n`;
            summary += `| üü† High | ${s.high || 0} | | Files Scanned | ${ai.files_scanned || 0} |\n`;
            summary += `| üü° Medium | ${s.medium || 0} | | Total Findings | ${ai.total_findings || findings.length} |\n`;
            summary += `| üîµ Low | ${s.low || 0} | | AI Powered | ‚úÖ |\n\n`;
            
            // Executive summary
            if (ai.executive_summary) {
              summary += `### üìã Executive Summary\n> ${ai.executive_summary}\n\n`;
            }
            
            // Findings by category
            if (findings.length > 0) {
              summary += `### üîç Findings\n\n`;
              summary += `| Severity | Issue | Location | SCF Control | Fix |\n`;
              summary += `|----------|-------|----------|-------------|-----|\n`;
              
              for (const f of findings.slice(0, 12)) {
                const sev = (f.severity || 'low').toUpperCase();
                const icon = sev === 'CRITICAL' ? 'üî¥' : sev === 'HIGH' ? 'üü†' : sev === 'MEDIUM' ? 'üü°' : 'üîµ';
                const cve = f.cve_id ? ` (${f.cve_id})` : '';
                const fix = (f.remediation || 'Review manually').substring(0, 50);
                summary += `| ${icon} ${sev} | ${f.title}${cve} | \`${f.file}:${f.line}\` | ${f.scf_control || '-'} | ${fix}... |\n`;
              }
              summary += `\n`;
            }
            
            // Compliance frameworks
            summary += `### üèõÔ∏è Compliance Mapping\n\n`;
            summary += `**Frameworks Checked:** SCF, SOC2, HIPAA, PCI-DSS, NIST\n\n`;
            
            const controls = new Set();
            findings.forEach(f => {
              if (f.scf_control) controls.add(f.scf_control);
            });
            if (controls.size > 0) {
              summary += `**Controls Violated:** ${[...controls].join(', ')}\n\n`;
            }
            
            // Audit evidence note
            summary += `<details>\n<summary>üìÅ Audit Evidence</summary>\n\n`;
            summary += `- **Scan Time:** ${new Date().toISOString()}\n`;
            summary += `- **PR:** #${context.issue.number}\n`;
            summary += `- **Commit:** ${context.sha?.substring(0, 7) || 'N/A'}\n`;
            summary += `- **Branch:** ${context.payload.pull_request?.head?.ref || 'N/A'}\n`;
            summary += `- **Report:** \`scan_report.json\` (artifact)\n`;
            summary += `</details>\n\n`;
            
            summary += `---\n*ü§ñ AI Compliance-as-Code Bot | Shift-left security powered by Google Gemini*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: Fail if Blocked
        if: steps.scan.outputs.decision == 'BLOCK'
        run: exit 1
